<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Companion AI</title>
    <link rel="stylesheet" href="static/css/bootstrap.min.css" crossorigin="anonymous">
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">PDX Workshop Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mod/add">Add Mod</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {{ .Game.Name }}
                        </a>
                        <ul class="dropdown-menu">
                            {{ range $index, $game := .Games }}
                                {{if eq $game.Identifier $.Game.Identifier }}
                                    {{ continue }}
                                {{end}}
                                <li><a class="dropdown-item" href="game/{{ $game.Identifier }}">{{ $game.Name }}</a></li>
                            {{ end }}
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="mx-4 mt-4">
    {{if .Message }}
        {{if eq .Message.Level 0 }}
            <div class="alert alert-success alert-dismissible mb-4" role="alert">
                {{ .Message.Message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {{end}}
        {{if eq .Message.Level 1 }}
            <div class="alert alert-warning alert-dismissible mb-4" role="alert">
                {{ .Message.Message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {{end}}
        {{if eq .Message.Level 2 }}
            <div class="alert alert-danger alert-dismissible mb-4" role="alert">
                {{ .Message.Message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {{end}}
    {{end}}

    {{ range $index, $mod := .Mods }}
        <div class="card mb-4">
            <div class="card-body">
                <form method="POST" action="mod/update/{{ $index }}">
                    <div class="row mb-3">
                        <label for="mod-identifier{{ $index }}" class="col-sm-2 col-form-label">Identifier</label>
                        <div class="col-sm-10">
                            <input name="identifier" type="number" class="form-control" id="mod-identifier{{ $index }}" value="{{ $mod.Configuration.Identifier }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label for="mod-directory{{ $index }}" class="col-sm-2 col-form-label">Mod Directory</label>
                        <div class="col-sm-10">
                            <input name="directory" type="text" class="form-control" id="mod-directory{{ $index }}" value="{{ $mod.Configuration.Directory }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label for="mod-description{{ $index }}" class="col-sm-2 col-form-label">Description File</label>
                        <div class="col-sm-10">
                            <input name="description" type="text" class="form-control" id="mod-description{{ $index }}" value="{{ $mod.Configuration.Description }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label for="mod-change-note{{ $index }}" class="col-sm-2 col-form-label">Change Note Directory</label>
                        <div class="col-sm-10">
                            <input name="change-note" type="text" class="form-control" id="mod-change-note{{ $index }}" value="{{ $mod.Configuration.ChangeNoteDirectory }}">
                        </div>
                    </div>
                    <div class="row justify-content-between">
                        <div class="col text-start">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                        <div class="col text-center">
                            <a class="btn btn-primary spinner-link" href="mod/upload/{{ $index }}">
                                <span class="original-text">Upload Mod</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                <span class="visually-hidden">Loading...</span>
                            </a>
                        </div>
                        <div class="col text-end">
                            <a class="btn btn-danger" href="mod/remove/{{ $index }}">Remove Mod</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    {{ end }}
    </div>

    <script src="static/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
        document.querySelectorAll('.spinner-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent default link behavior

                const originalText = this.querySelector('.original-text');
                const spinner = this.querySelector('.spinner-border');
                const loadingText = this.querySelector('.visually-hidden');

                // Disable and show spinner
                this.classList.add('disabled');
                originalText.classList.add('d-none');
                spinner.classList.remove('d-none');
                loadingText.classList.remove('visually-hidden');

                // Parse href and open after delay
                const url = this.getAttribute('href');
                setTimeout(() => {
                    window.open(url, '_blank');
                }, 1000);
            });
        });
    </script>
</body>
</html>